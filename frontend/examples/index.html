<!DOCTYPE html>
<html lang="es">
<head>
    <script type="importmap">
    {
        "imports": {
            "three": "../build/three.webgpu.js",
            "three/webgpu": "../build/three.webgpu.js",
            "three/tsl": "../build/three.tsl.js",
            "three/addons/": "./jsm/"
        }
    }
    </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pronóstico Futurista</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            overflow: hidden; /* Evita barras de scroll por el canvas */
        }
        #bg-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1; /* Coloca el canvas detrás del contenido */
        }
        /* Estilo para el placeholder del input */
        input::placeholder {
            color: #9ca3af;
        }
    </style>
</head>
<body class="bg-gray-900 text-white">

    <!-- Contenedor para la escena 3D de Three.js -->
    <canvas id="bg-canvas"></canvas>

    <!-- Contenedor principal de la UI -->
    <main class="relative z-10 flex flex-col items-center justify-center h-screen p-4 transition-opacity duration-1000" id="main-ui">
        <div class="text-center w-full max-w-2xl">
            <h1 class="text-4xl md:text-6xl font-bold mb-6 text-shadow-lg">Cuéntame, ¿cuál es tu plan?</h1>
            <p class="text-lg md:text-xl text-gray-300 mb-8">Escribe un lugar y una fecha futura (ej. "París en 3 meses") para obtener un pronóstico especulativo.</p>
            
            <form id="location-form" class="flex flex-col sm:flex-row gap-3">
                <input type="text" id="location-input" placeholder="Ej: Tokio en 6 meses..." class="w-full px-5 py-4 text-lg bg-gray-800 bg-opacity-70 border border-gray-600 rounded-full focus:ring-2 focus:ring-blue-500 focus:outline-none placeholder-gray-500 transition-all duration-300">
                <button type="submit" class="px-8 py-4 bg-blue-600 hover:bg-blue-700 rounded-full text-lg font-semibold transition-all duration-300">
                    Visualizar
                </button>
            </form>
        </div>
    </main>
    
    <!-- Contenedor para mostrar los resultados del pronóstico -->
    <div id="forecast-result" class="hidden absolute z-20 top-0 left-0 w-full h-full flex items-center justify-center p-4 bg-black bg-opacity-50 backdrop-blur-sm">
        <div class="bg-gray-800 bg-opacity-80 p-8 rounded-2xl shadow-2xl max-w-md w-full border border-gray-700">
            <h2 class="text-3xl font-bold mb-2" id="forecast-location"></h2>
            <p class="text-lg text-blue-300 mb-6" id="forecast-date"></p>
            <div id="forecast-details">
                <!-- El contenido del pronóstico se insertará aquí -->
            </div>
             <p class="text-sm text-gray-400 mt-6 italic">Nota: Este es un pronóstico simulado con fines demostrativos.</p>
            <button id="back-button" class="w-full mt-6 px-6 py-3 bg-gray-600 hover:bg-gray-700 rounded-full text-lg font-semibold transition-colors">Volver</button>
        </div>
    </div>

    <script type="module">
        // Importar Three.js desde un CDN estable
        import * as THREE from 'https://cdn.jsdelivr.net/npm/three@0.128.0/build/three.module.js';

        // --- Configuración básica de la escena ---
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ 
            canvas: document.querySelector('#bg-canvas'),
            antialias: true 
        });

        renderer.setPixelRatio(window.devicePixelRatio);
        renderer.setSize(window.innerWidth, window.innerHeight);
        camera.position.setZ(15);

        scene.background = new THREE.Color(0x000011);

        // --- Creación del Planeta Tierra ---
        const earthGeometry = new THREE.SphereGeometry(5, 64, 64);
        const textureLoader = new THREE.TextureLoader();
        const earthTexture = textureLoader.load('https://threejs.org/examples/textures/land_ocean_ice_cloud_2048.jpg');
        const earthMaterial = new THREE.MeshBasicMaterial({ map: earthTexture });
        const earth = new THREE.Mesh(earthGeometry, earthMaterial);
        scene.add(earth);
        
        // --- Creación del fondo de estrellas ---
        const starGeometry = new THREE.BufferGeometry();
        const starMaterial = new THREE.PointsMaterial({ color: 0xffffff, size: 0.05 });
        const starVertices = [];
        for (let i = 0; i < 10000; i++) {
            const x = (Math.random() - 0.5) * 2000;
            const y = (Math.random() - 0.5) * 2000;
            const z = (Math.random() - 0.5) * 2000;
            const dist = Math.sqrt(x*x + y*y + z*z);
            if (dist > 300) starVertices.push(x, y, z); // Solo estrellas lejanas
        }
        starGeometry.setAttribute('position', new THREE.Float32BufferAttribute(starVertices, 3));
        const stars = new THREE.Points(starGeometry, starMaterial);
        scene.add(stars);

        // --- Datos de ciudades para simulación de zoom ---
        const cityCoordinates = {
            'tokio': { lat: 35.6895, lon: 139.6917 },
            'paris': { lat: 48.8566, lon: 2.3522 },
            'londres': { lat: 51.5074, lon: -0.1278 },
            'new york': { lat: 40.7128, lon: -74.0060 },
            'sydney': { lat: -33.8688, lon: 151.2093 },
            'el cairo': { lat: 30.0444, lon: 31.2357 },
            'rio de janeiro': { lat: -22.9068, lon: -43.1729 },
            'mexico': { lat: 19.4326, lon: -99.1332 }
        };

        // --- Animación y Controles ---
        let targetRotation = { x: 0, y: 0.001 };
        let targetPosition = new THREE.Vector3(0, 0, 15);
        let forecastRequest = null;

        function animate() {
            requestAnimationFrame(animate);

            earth.rotation.y += targetRotation.y;
            earth.rotation.x += targetRotation.x;
            
            camera.position.lerp(targetPosition, 0.05);
            camera.lookAt(0, 0, 0);

            if (forecastRequest && camera.position.distanceTo(targetPosition) < 0.1) {
                displayForecast(forecastRequest.city, forecastRequest.query);
                forecastRequest = null;
            }

            renderer.render(scene, camera);
        }
        animate();
        
        // --- Lógica de la Interfaz ---
        const form = document.getElementById('location-form');
        const input = document.getElementById('location-input');
        const mainUI = document.getElementById('main-ui');
        const forecastResult = document.getElementById('forecast-result');
        const backButton = document.getElementById('back-button');

        form.addEventListener('submit', (e) => {
            e.preventDefault();
            const query = input.value.toLowerCase().trim();
            if (!query) return;

            const foundCity = Object.keys(cityCoordinates).find(city => query.includes(city));

            if (foundCity) {
                const { lat, lon } = cityCoordinates[foundCity];
                zoomToLocation(lat, lon);
                forecastRequest = { city: foundCity, query: query };
            } else {
                targetPosition.set(0, 0, 8);
                forecastRequest = { city: "un lugar desconocido", query: query };
            }

            mainUI.style.opacity = '0';
        });
        
        backButton.addEventListener('click', () => {
            resetView();
        });

        function latLonToVector3(lat, lon, radius) {
            const phi = (90 - lat) * (Math.PI / 180);
            const theta = (lon + 180) * (Math.PI / 180);

            const x = -(radius * Math.sin(phi) * Math.cos(theta));
            const y = radius * Math.cos(phi);
            const z = radius * Math.sin(phi) * Math.sin(theta);

            return new THREE.Vector3(x, y, z);
        }

        function zoomToLocation(lat, lon) {
            const radius = 5;
            const target3D = latLonToVector3(lat, lon, radius); 
            const cameraOffset = target3D.normalize().multiplyScalar(10);
            targetPosition.copy(cameraOffset);
        }

        function resetView() {
            targetPosition.set(0, 0, 15);
            mainUI.style.opacity = '1';
            forecastResult.classList.add('hidden');
            forecastRequest = null;
        }
        
        // --- Simulación de API de Pronóstico ---
        function displayForecast(city, query) {
            const forecastLocation = document.getElementById('forecast-location');
            const forecastDate = document.getElementById('forecast-date');
            const forecastDetails = document.getElementById('forecast-details');
            
            const timeMatch = query.match(/en (\d+ \w+)/);
            const dateText = timeMatch ? `Para ${timeMatch[1]}` : 'En un futuro cercano';

            forecastLocation.textContent = city.charAt(0).toUpperCase() + city.slice(1);
            forecastDate.textContent = dateText;
            
            const temp = (Math.random() * 25 + 5).toFixed(1);
            const precipitation = (Math.random() * 100).toFixed(0);
            const wind = (Math.random() * 30 + 5).toFixed(1);
            const summaries = ["Se esperan condiciones climáticas estables.", "Posibilidad de eventos meteorológicos anómalos.", "Tendencia a temperaturas por encima de la media histórica.", "Periodos de sequía alternados con lluvias intensas."];
            const summary = summaries[Math.floor(Math.random() * summaries.length)];

            forecastDetails.innerHTML = `
                <div class="space-y-4 text-left">
                    <p class="text-lg"><strong>Temperatura Promedio:</strong> ${temp}°C</p>
                    <p class="text-lg"><strong>Probabilidad de Precipitación:</strong> ${precipitation}%</p>
                    <p class="text-lg"><strong>Viento Promedio:</strong> ${wind} km/h</p>
                    <p class="text-lg mt-4"><strong>Resumen:</strong> ${summary}</p>
                </div>
            `;
            
            forecastResult.classList.remove('hidden');
        }
        
        // --- Manejo del redimensionamiento de la ventana ---
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });

    </script>
</body>
</html>

